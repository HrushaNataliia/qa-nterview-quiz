{% extends "base.html" %}

{% block title %}–ì–æ–ª–æ–≤–Ω–∞ - –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —ñ–Ω—Ç–µ—Ä–≤'—é QA{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="text-center mb-0">–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —ñ–Ω—Ç–µ—Ä–≤'—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–ª—å–Ω–∏–∫–∞</h2>
            </div>
            <div class="card-body">
                <p class="text-center text-muted mb-4">
                    –û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —ñ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å
                </p>

                <form id="quiz-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="language" class="form-label">–ú–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è:</label>
                                <select class="form-select" id="language" name="language" required>
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å –º–æ–≤—É</option>
                                    {% for key, value in languages.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="framework" class="form-label">–§—Ä–µ–π–º–≤–æ—Ä–∫ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:</label>
                                <select class="form-select" id="framework" name="framework" required>
                                    <option value="">–û–±–µ—Ä—ñ—Ç—å —Ñ—Ä–µ–π–º–≤–æ—Ä–∫</option>
                                    {% for key, value in frameworks.items() %}
                                    <option value="{{ key }}">{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="start-btn">
                            –ü–æ—á–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
                        </button>
                    </div>
                </form>

                <div id="loading" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                    </div>
                    <p class="mt-2">–ì–µ–Ω–µ—Ä—É—î–º–æ –ø–∏—Ç–∞–Ω–Ω—è...</p>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-body">
                <h5>–©–æ –≤–∞—Å —á–µ–∫–∞—î:</h5>
                <ul class="list-unstyled">
                    <li class="mb-2">üìö <strong>QC —Ç–µ–æ—Ä—ñ—è</strong> - –æ—Å–Ω–æ–≤–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ü–ó</li>
                    <li class="mb-2">ü§ñ <strong>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—è</strong> - –ø—Ä–∏–Ω—Ü–∏–ø–∏ —ñ –ø—ñ–¥—Ö–æ–¥–∏</li>
                    <li class="mb-2">üíª <strong>–ú–æ–≤–∞ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è</strong> - –æ–±—Ä–∞–Ω–∞ –≤–∞–º–∏ –º–æ–≤–∞</li>
                    <li class="mb-2">üõ†Ô∏è <strong>–§—Ä–µ–π–º–≤–æ—Ä–∫</strong> - –æ–±—Ä–∞–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- –ö–≤—ñ–∑ -->
<div id="quiz-container" style="display: none;">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" id="progress-bar"></div>
                    </div>
                    <p class="text-center mt-2 mb-0">
                        –ü–∏—Ç–∞–Ω–Ω—è <span id="current-question">1</span> –∑ <span id="total-questions">10</span>
                    </p>
                </div>
                <div class="card-body">
                    <h4 id="question-text" class="mb-4"></h4>
                    <div id="options-container"></div>
                    <div class="text-center mt-4">
                        <button class="btn btn-success" id="submit-answer" disabled>
                            –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentQuestion = null;
let selectedAnswer = null;

document.getElementById('quiz-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const language = document.getElementById('language').value;
    const framework = document.getElementById('framework').value;

    if (!language || !framework) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –º–æ–≤—É –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫');
        return;
    }

    document.getElementById('loading').style.display = 'block';
    document.getElementById('start-btn').disabled = true;

    try {
        const response = await fetch('/start_quiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ language, framework })
        });

        const data = await response.json();

        if (data.status === 'success') {
            document.querySelector('.card').style.display = 'none';
            document.querySelector('.card.mt-4').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('total-questions').textContent = data.total_questions;
            loadQuestion();
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø–∏—Ç–∞–Ω—å');
        console.error(error);
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('start-btn').disabled = false;
    }
});

async function loadQuestion() {
    try {
        const response = await fetch('/get_question');
        const data = await response.json();

        if (data.finished) {
            window.location.href = '/results';
            return;
        }

        currentQuestion = data.question;
        document.getElementById('question-text').textContent = currentQuestion.question;
        document.getElementById('current-question').textContent = data.current;

        const progress = (data.current / data.total) * 100;
        document.getElementById('progress-bar').style.width = progress + '%';

        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';

        const letters = ['A', 'B', 'C', 'D'];
        currentQuestion.options.forEach((option, index) => {
            const div = document.createElement('div');
            div.className = 'form-check mb-2';
            div.innerHTML = `
                <input class="form-check-input" type="radio" name="answer" id="option-${letters[index]}" value="${letters[index]}">
                <label class="form-check-label" for="option-${letters[index]}">
                    <strong>${letters[index]}.</strong> ${option}
                </label>
            `;
            optionsContainer.appendChild(div);
        });

        document.querySelectorAll('input[name="answer"]').forEach(input => {
            input.addEventListener('change', function() {
                selectedAnswer = this.value;
                document.getElementById('submit-answer').disabled = false;
            });
        });

        selectedAnswer = null;
        document.getElementById('submit-answer').disabled = true;

    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–∏—Ç–∞–Ω–Ω—è:', error);
    }
}

document.getElementById('submit-answer').addEventListener('click', async function() {
    if (!selectedAnswer) return;

    try {
        const response = await fetch('/submit_answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ answer: selectedAnswer })
        });

        const data = await response.json();

        document.querySelectorAll('input[name="answer"]').forEach(input => {
            const label = input.parentElement;
            if (input.value === data.correct_answer) {
                label.classList.add('text-success');
                label.style.backgroundColor = '#d1edff';
            } else if (input.value === selectedAnswer && !data.correct) {
                label.classList.add('text-danger');
                label.style.backgroundColor = '#f8d7da';
            }
            input.disabled = true;
        });

        setTimeout(() => {
            loadQuestion();
        }, 2000);

    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:', error);
    }
});
</script>
{% endblock %}
